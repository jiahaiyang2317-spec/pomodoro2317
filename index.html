<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OFF</title>
    <style>
        :root { --bg: #000; --text: #fff; --accent: #ff6b6b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }
        
        /* 页面切换动画 */
        .page { position: absolute; width: 100%; height: 100%; transition: 0.5s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .hidden { transform: translateY(100%); opacity: 0; pointer-events: none; }

        /* 第一页：仪表盘 */
        .datetime { font-size: 1.2rem; opacity: 0.8; margin-bottom: 10px; font-variant-numeric: tabular-nums; }
        .ring-container { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .bg-circle { stroke: rgba(255,255,255,0.1); }
        .progress-circle { stroke: var(--accent); transition: stroke-dashoffset 0.3s linear; }
        .timer-text { position: absolute; font-size: 4rem; font-weight: 800; }
        .chance-tag { margin-top: 20px; font-size: 0.9rem; color: #aaa; }

        /* 第二页：专注设置 */
        .settings-card { background: rgba(255,255,255,0.1); border-radius: 30px; padding: 30px; width: 100%; text-align: center; }
        .mode-btn { padding: 15px 30px; border-radius: 20px; border: 1px solid #555; background: none; color: #fff; margin: 5px; font-size: 1rem; }
        .mode-btn.active { background: #fff; color: #000; border-color: #fff; }
        .start-btn { margin-top: 30px; width: 100%; padding: 20px; border-radius: 20px; border: none; background: var(--accent); color: #fff; font-size: 1.2rem; font-weight: bold; }
        
        .nav-link { margin-top: 40px; text-decoration: underline; color: #888; font-size: 0.9rem; border: none; background: none; }
    </style>
</head>
<body>

    <div id="page-dash" class="page">
        <div class="datetime" id="current-date">2024年02月15日 00:00:00</div>
        <div class="ring-container">
            <svg viewBox="0 0 100 100">
                <circle class="bg-circle" cx="50" cy="50" r="45"></circle>
                <circle id="progress" class="progress-circle" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="283"></circle>
            </svg>
            <div class="timer-text" id="display">25:00</div>
        </div>
        <div class="chance-tag" id="chance-text">剩余退出机会: 2</div>
        <button class="nav-link" id="to-settings" onclick="goPage('settings')">设置专注时长</button>
    </div>

    <div id="page-settings" class="page hidden">
        <div class="settings-card">
            <h2>专注时长</h2>
            <div id="mode-selector">
                <button class="mode-btn" onclick="setTimer(60, this)">1分钟</button>
                <button class="mode-btn active" onclick="setTimer(1500, this)">25分钟</button>
                <button class="mode-btn" onclick="setTimer(3000, this)">50分钟</button>
            </div>
            <button class="start-btn" onclick="startFocus()">开始专注</button>
        </div>
        <button class="nav-link" onclick="goPage('dash')">取消</button>
    </div>

    <script>
        let timeLeft = 1500, totalTime = 1500, timerId = null;
        let chances = localStorage.getItem('focus_chances') || 2;

        function updateDateTime() {
            const now = new Date();
            const fmt = (n) => String(n).padStart(2, '0');
            document.getElementById('current-date').innerText = 
                `${now.getFullYear()}年${fmt(now.getMonth()+1)}月${fmt(now.getDate())}日 ${fmt(now.getHours())}:${fmt(now.getMinutes())}:${fmt(now.getSeconds())}`;
        }
        setInterval(updateDateTime, 1000);

        function goPage(page) {
            if (timerId && page === 'settings') return alert('专注中不可更改设置');
            document.getElementById('page-dash').classList.toggle('hidden', page !== 'dash');
            document.getElementById('page-settings').classList.toggle('hidden', page !== 'settings');
        }

        function setTimer(sec, btn) {
            totalTime = timeLeft = sec;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateUI();
        }

        function updateUI() {
            const min = Math.floor(timeLeft / 60);
            const sec = timeLeft % 60;
            document.getElementById('display').innerText = `${min}:${String(sec).padStart(2, '0')}`;
            const offset = 283 - (timeLeft / totalTime) * 283;
            document.getElementById('progress').style.strokeDashoffset = offset;
            document.getElementById('chance-text').innerText = `剩余退出机会: ${chances}`;
        }

        function startFocus() {
            if (timerId) return;
            goPage('dash');
            document.getElementById('to-settings').style.visibility = 'hidden';
            document.title = "ON";
            timerId = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateUI();
                } else {
                    stopFocus("完成！");
                }
            }, 1000);
        }

        function stopFocus(msg) {
            clearInterval(timerId);
            timerId = null;
            document.title = "OFF";
            document.getElementById('to-settings').style.visibility = 'visible';
            if(msg) alert(msg);
        }

        // 处理 Auto.js 发来的退出请求
        window.requestExit = function() {
            if (!timerId) return true; // 没在专注，随便退
            if (chances > 0) {
                chances--;
                localStorage.setItem('focus_chances', chances);
                updateUI();
                if (chances == 0) stopFocus("消耗最后机会退出！");
                return true;
            }
            return false; // 没机会了，不准退
        }
        
        updateUI();
    </script>
</body>
</html>
